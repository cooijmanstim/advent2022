b â† ".#"âŠ> â€¢FLinesâŠ‘â€¢args

System â† {ğ•©
  b â‡ b
  t â‡ 0
  nelves â† +Â´â¥Šb
  ShowBoard â‡ {ğ•©: â€¢Show bâŠ".#"}
  Step â‡ {ğ•©
    b â†© (âŠ¢â†‘ËÂ·â‰âŸœÂ¬2+â‰¢) CroppedBoard@  # crop to bbox + one unit of padding
    nnâ€¿ssâ€¿wwâ€¿ee â† â¥Š âŠ¢â€¿â‰ {ğ•âŒ¾ ğ• b}âŒœ Â»â€¿Â«
    nwâ€¿neâ€¿swâ€¿se â† â¥Š nnâ€¿ss {ğ•âŒ¾â‰ ğ•¨}âŒœ Â»â€¿Â«
    conditions â† t âŒ½ [bâˆ§Â¬âˆ¨Â´ nwâ€¿nnâ€¿ne,
                      bâˆ§Â¬âˆ¨Â´ swâ€¿ssâ€¿se,
                      bâˆ§Â¬âˆ¨Â´ nwâ€¿wwâ€¿sw,
                      bâˆ§Â¬âˆ¨Â´ neâ€¿eeâ€¿se]
    fs â† t âŒ½ âŸ¨1âŠ¸âŒ½ , Â¯1âŠ¸âŒ½ , 1âŠ¸âŒ½âŒ¾â‰ , Â¯1âŠ¸âŒ½âŒ¾â‰ âŸ©
    needmove â† b âˆ§ âˆ¨Â´ nwâ€¿nnâ€¿neâ€¿wwâ€¿eeâ€¿swâ€¿ssâ€¿se
    proposals â† (4Ã—Â¬needmove) + needmoveÃ— (âŠâŸœ1)â‰1 1â€¿2â€¿0 â‰â¼ conditions
    collisions â† 1<+Â´ {ğ•Šiâ€¿f: F proposals=i}Â¨ (â†•4)â‹ˆÂ¨fs
    b â†© (bâˆ§proposals=4) âˆ¨Â´ {ğ•Šiâ€¿f:
      srcâ† bâˆ§proposals=i â‹„ dst â† F src
      cancel â† Fâ¼ collisionsâˆ§dst
      (cancelâˆ§src)âˆ¨F(Â¬cancel)âˆ§src
    }Â¨ (â†•4)â‹ˆÂ¨fs
    !nelves = +Â´â¥Šb
    t+â†©1
    âˆ¨Â´â¥Šneedmove
  }
  CroppedBoard â‡ {ğ•©
    tl â† {âŠ‘âŒŠÂ´1âŠ¸(âŠËœ)Ë˜ ğ• b}Â¨ âŸ¨â‰ , âŠ¢âŸ©
    br â† {âŠ‘âŒŠÂ´{(âŒ½ ğ•©)âŠ1}Ë˜ ğ• b}Â¨ âŸ¨â‰ ,âŠ¢âŸ©
    (-br)â†“tlâ†“b
  }
}

{ # part one
  x â† System@
  {ğ•©: x.Step@}âŸ 10 @
  â€¢Show +Â´â¥Š Â¬x.CroppedBoard@
}

{ # part two
  x â† System@
  {ğ•Šğ•©:x.Step@}â€¢_while_ âŠ¢ 1
  â€¢Show x.t
}

