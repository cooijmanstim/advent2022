ParseNat â† 10âŠ¸Ã—âŠ¸+ËœÂ´ âˆ˜âŒ½ -âŸœ'0'
ParseNum â† {ğ•Šğ•©: '-'â‰¡âŠ‘ğ•© ? -ParseNat 1â†“ğ•©; ParseNat ğ•©}
Stretches â† {mğ•Šs: s âŠ”Ëœ +`mâ‰ Â»m}

linesâ†â€¢FLinesâŠ‘â€¢args
moves â† {"L": 'L'; "R": 'R'; ParseNum ğ•©}Â¨ {(ğ•©âˆŠ"LR") Stretches ğ•©} Â¯1âŠ‘lines
board â† > {ğ•Šbl: {ğ•©â†‘ËœâŒˆÂ´â‰ Â¨bl}Â¨ bl} Â¯2â†“lines

{ # part one
  hw â† â‰¢board
  x â† âŸ¨0, âŠ‘'.'âŠËœâŠboardâŸ©
  dx â† 0â€¿1
  Rotate â† (Â¯1â€¿1âŠ¸Ã—)âˆ˜âŒ½  # ccw
  {ğ•Štâ€¿move:
    {'L': dx Rotate â†©;
     'R': dx Rotateâ¼â†©;
     ğ•Šn: axis â† âŠ‘1âŠËœ0â‰ dx
         invert â† 0>+Â´dx
         # see what's ahead of us (we are at idx 0)
         line â† invertâ—¶âŠ¢â€¿âŒ½  (invert+axisâŠ‘x)âŒ½  ((1-axis)âŠ‘x) âŠ axisâ—¶â‰â€¿âŠ¢ board
         !(âŠ‘line)=(xâŠ‘board)  # we are at idx 0
         !nâ‰¤â‰ line  # expecting to wrap at most once (but can just replicate if this fails)

         # remove empty cells but keep track of real distances to us
         dists â† â†•â‰ line
         nonempty â† lineâ‰ ' ' â‹„ ! âˆ¨Â´nonempty
         line â†© nonempty / line â‹„ dists â†© nonempty / dists

         nwall â† âŠ‘lineâŠ'#' â‹„ !nwall>0
         newx â† hw| x+ dxÃ—distsâŠ‘ËœnâŒŠnwall-1
         !'#'â‰ newxâŠ‘board â‹„ !' 'â‰ newxâŠ‘board
         x â†© newx
    } move
  }Â¨ ((â†•â‰ )â‹ˆÂ¨âŠ¢) moves
  â€¢Show  ({0â€¿1:0;Â¯1â€¿0:3; 0â€¿Â¯1:2; 1â€¿0:1}dx) +Â´1000â€¿4Ã—1+x
}

{ # part two
  rightâ€¿downâ€¿leftâ€¿up â† â†•4
  dxs â† [0â€¿1, 1â€¿0, 0â€¿Â¯1, Â¯1â€¿0]
  topology â† {
    "ex"â‰¡Â¯2â†‘âŠ‘â€¢args ? # example
      # cut up the board into cube faces (and keep track of indices in 2d projection)
      quadsâ€¿indicesâ‡ {[0â€¿0â€¿1â€¿0,1â€¿1â€¿1â€¿0,0â€¿0â€¿1â€¿1] /â—‹â¥Š <â‰2 0â€¿2â€¿1â€¿3â‰ 3â€¿4â€¿4â€¿4 â¥Š ğ•©}Â¨ boardâ€¿(â†•â‰¢board)
      # quads and their connections ((0â€¿rightâŠ‘edges)=5â€¿left <=> quad 0 right connects to quad 5 left
      edgesâ‡ [[5â€¿left,  3â€¿down,  2â€¿down, 1â€¿down ],
              [2â€¿right, 4â€¿up,    5â€¿up,   0â€¿down ],
              [3â€¿right, 4â€¿right, 1â€¿left, 0â€¿right],
              [5â€¿down,  4â€¿down,  2â€¿left, 0â€¿up   ],
              [5â€¿right, 1â€¿up,    2â€¿up,   3â€¿up   ],
              [0â€¿left,  1â€¿right, 4â€¿left, 3â€¿left ]]
      # - indicates coordinate sign switch AFTER any axis swap
      signsâ‡ [[-â€¿-, -â€¿+, -â€¿+, +â€¿-],
              [+â€¿-, +â€¿-, -â€¿-, +â€¿-],
              [+â€¿-, +â€¿-, +â€¿-, +â€¿+],
              [-â€¿-, -â€¿+, +â€¿-, -â€¿+],
              [+â€¿-, +â€¿-, -â€¿-, -â€¿+],
              [-â€¿+, -â€¿-, +â€¿-, -â€¿-]]
      qshapeâ‡ â‰¢âŠ‘quads
    ; # input
      quadsâ€¿indicesâ‡ {[0â€¿1â€¿1,0â€¿1â€¿0,1â€¿1â€¿0,1â€¿0â€¿0] /â—‹â¥Š <â‰2 0â€¿2â€¿1â€¿3â‰ 4â€¿50â€¿3â€¿50 â¥Š ğ•©}Â¨ boardâ€¿(â†•â‰¢board)
      edgesâ‡ [[1â€¿right, 2â€¿down,  3â€¿right, 5â€¿right],
              [4â€¿left,  2â€¿left,  0â€¿left,  5â€¿up   ],
              [1â€¿up,    4â€¿down,  3â€¿down,  0â€¿up   ],
              [4â€¿right, 5â€¿down,  0â€¿right, 2â€¿right],
              [1â€¿left,  5â€¿left,  3â€¿left,  2â€¿up   ],
              [4â€¿up,    1â€¿down,  0â€¿down,  3â€¿up   ]]
      signsâ‡ [[+â€¿-, -â€¿+, -â€¿+, +â€¿+],
              [-â€¿+, +â€¿+, +â€¿-, -â€¿+],
              [+â€¿+, -â€¿+, +â€¿+, -â€¿+],
              [+â€¿-, -â€¿+, -â€¿+, +â€¿+],
              [-â€¿+, +â€¿+, +â€¿-, -â€¿+],
              [+â€¿+, -â€¿+, +â€¿+, -â€¿+]]
      qshapeâ‡ â‰¢âŠ‘quads
  }

  WithinQuad â† âˆ§Â´ (0âŠ¸â‰¤âˆ§<âŸœtopology.qshape)
  Advance â† {ğ•Šqâ€¿xâ€¿dir:
    dx â† dir âŠ dxs
    {WithinQuad x+dx
      ? qâ€¿(x+dx)â€¿dir
      ; qnewâ€¿dirnew â† qâ€¿dirâŠ‘<â‰1 topology.edges
        signs â† qâ€¿dirâŠ‘<â‰1 topology.signs
        xnew â† topology.qshape| signs {âŠ‘ğ•¨=âŸ¨-âŸ©?-ğ•©+1;ğ•©}Â¨ (0=+Â´dxÃ—dirnewâŠdxs)â—¶âŠ¢â€¿âŒ½ x
        !WithinQuad xnew
        qnewâ€¿xnewâ€¿dirnew
    }
  }
  GetTrueIndex â† {ğ•Šqâ€¿xâ€¿dir: xâŠ‘qâŠ‘topology.indices}

  q â† 0 â‹„ x â† 0â€¿0 â‹„ dir â† 0
  {ğ•Štâ€¿move:
    {'L': dir â†© 4|dir-1;
     'R': dir â†© 4|dir+1;
     ğ•Šn: {F n: {n â‰¤ 0 ? @;
                qnewâ€¿xnewâ€¿dirnew â† Advance qâ€¿xâ€¿dir
                {'#'=xnewâŠ‘qnewâŠ‘topology.quads ? @;
                 qâ€¿xâ€¿dir â†© qnewâ€¿xnewâ€¿dirnew
                 F n-1}}} n
    } move
  }Â¨ ((â†•â‰ )â‹ˆÂ¨âŠ¢) moves
  â€¢Show dir +Â´1000â€¿4Ã—1+GetTrueIndex qâ€¿xâ€¿dir
}

